name: Terraform Destroy with Terragrunt

on:
  workflow_dispatch:

jobs:
  terraform-destroy:
    runs-on: ubuntu-latest
    env:
      GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
      GOOGLE_REGION: ${{ secrets.GCP_REGION }}
      GCS_BUCKET: my-terraform-state-bucket   # <-- Your bucket name here
      TERRAGRUNT_TFPATH: terraform

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Destroy Resources (Firewalls, GKE, Network)
        run: |
          for dir in firewall gke-cluster network; do
            echo "Destroying resources in $dir..."
            cd $dir
            terragrunt destroy \
              --terragrunt-non-interactive \
              --auto-approve \
              --terragrunt-override-attr bucket=$GCS_BUCKET
            cd ..
          done
