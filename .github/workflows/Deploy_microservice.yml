name: Deploy Microservice to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      CLUSTER_NAME: power3
      CLUSTER_REGION: us-east1
      RELEASE_NAME: microservice
      NAMESPACE: dev
      STATIC_IP: ${{ secrets.GCP_STATIC_IP }}   # <-- store the actual IP in GitHub secrets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials $CLUSTER_NAME \
            --region $CLUSTER_REGION \
            --project $PROJECT_ID

      - name: Create namespace if not exists
        run: |
          kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

      - name: Deploy with Helm
        run: |
          helm upgrade --install "$RELEASE_NAME" ./helm/microservice \
            --namespace "$NAMESPACE" \
            --set ingress.hosts[0].host="${STATIC_IP}.nip.io"

      - name: Wait for rollout
        run: |
          echo "â³ Waiting for pods to be ready..."
          kubectl rollout status deployment/$RELEASE_NAME -n $NAMESPACE

      - name: List resources
        run: |
          echo "ðŸ“œ Listing resources:"
          kubectl get pods -n $NAMESPACE
          echo ""
          kubectl get svc -n $NAMESPACE
          echo ""
          kubectl get ingress -n $NAMESPACE
          echo ""
          echo "ðŸŒ Test URL: http://${STATIC_IP}.nip.io"

