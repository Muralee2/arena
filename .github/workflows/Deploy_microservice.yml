name: Deploy to GKE

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      CLUSTER_NAME: power3
      CLUSTER_REGION: us-east1
      RELEASE_NAME: microservice
      NAMESPACE: dev

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3. Setup gcloud SDK
      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 4. Install GKE auth plugin
      - name: Install gke-gcloud-auth-plugin
        run: |
          echo "ðŸ”§ Installing gke-gcloud-auth-plugin..."
          gcloud components install gke-gcloud-auth-plugin --quiet

      # 5. Get cluster credentials
      - name: Get GKE credentials
        run: |
          echo "â³ Fetching GKE credentials..."
          gcloud container clusters get-credentials "$CLUSTER_NAME" \
            --region "$CLUSTER_REGION" \
            --project "$PROJECT_ID"

      # 6. Setup kubectl + helm
      - name: Set up Kubernetes tools
        uses: azure/setup-kubectl@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4

      # 7. Deploy Microservice via Helm
      - name: Deploy Microservice via Helm
        run: |
          helm upgrade --install "$RELEASE_NAME" ./helm/microservice \
            --namespace "$NAMESPACE" \
            --create-namespace \
            --set ingress.enabled=true \
            --set ingress.className=nginx \
            --set ingress.hosts[0].host="placeholder.nip.io" \
            --set ingress.hosts[0].paths[0].path="/" \
            --set ingress.hosts[0].paths[0].pathType=Prefix

      # 8. Verify deployment rollout
      - name: Verify Deployment
        run: |
          echo "â³ Waiting for pods to be ready..."
          kubectl rollout status deployment/"$RELEASE_NAME" -n "$NAMESPACE" --timeout=180s
          echo "ðŸ“œ Listing resources:"
          kubectl get pods,svc,ingress -n "$NAMESPACE"

      # 9. Get Ingress External IP and publish Test URL
      - name: Get Ingress External IP
        id: ingress
        run: |
          echo "â³ Waiting for ingress external IP..."
          for i in {1..30}; do
            INGRESS_IP=$(kubectl get ingress "$RELEASE_NAME" -n "$NAMESPACE" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$INGRESS_IP" ]; then
              echo "âœ… Ingress IP assigned: $INGRESS_IP"
              echo "url=http://$INGRESS_IP.nip.io" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "âŒ› Still waiting for ingress IP... ($i/30)"
            sleep 10
          done
          echo "âŒ Ingress external IP was not assigned in time"
          exit 1

      # 10. Add summary with final Test URL
      - name: Publish Test URL Summary
        run: |
          echo "### ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… App is available at: [${{ steps.ingress.outputs.url }}](${{ steps.ingress.outputs.url }})" >> $GITHUB_STEP_SUMMARY

